import { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Checkbox } from '@/components/ui/checkbox'
import { Progress } from '@/components/ui/progress'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible'
import { ChevronDown, ChevronRight, CheckCircle2, Clock, AlertCircle, Save } from 'lucide-react'
import { useToast } from '@/hooks/use-toast'

interface ChecklistItem {
  id: string
  title: string
  completed: boolean
  priority: 'high' | 'medium' | 'low'
  category: string
}

interface ChecklistCategory {
  id: string
  title: string
  description: string
  icon: string
  items: ChecklistItem[]
  required: boolean
}

interface TripChecklistProps {
  tripId: string
  tripStatus: string
}

export function TripChecklist({ tripId, tripStatus }: TripChecklistProps) {
  const { toast } = useToast()
  const [checklist, setChecklist] = useState<ChecklistCategory[]>([])
  const [expandedCategories, setExpandedCategories] = useState<Set<string>>(new Set())
  const [hasChanges, setHasChanges] = useState(false)

  // Ï∂úÏû• Îã®Í≥ÑÎ≥Ñ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÌÖúÌîåÎ¶ø
  const checklistTemplate: ChecklistCategory[] = [
    {
      id: 'planning',
      title: 'Ï∂úÏû• Í≥ÑÌöç ÏàòÎ¶Ω',
      description: 'Ï∂úÏû•Ïùò Í∏∞Î≥∏ Í≥ÑÌöçÏùÑ ÏàòÎ¶ΩÌï©ÎãàÎã§',
      icon: 'üìã',
      required: true,
      items: [
        { id: 'destination', title: 'Î™©Ï†ÅÏßÄ Î∞è ÏùºÏ†ï ÌôïÏ†ï', completed: false, priority: 'high', category: 'planning' },
        { id: 'purpose', title: 'Ï∂úÏû• Î™©Ï†Å Î∞è ÏóÖÎ¨¥ ÎÇ¥Ïö© Ï†ïÎ¶¨', completed: false, priority: 'high', category: 'planning' },
        { id: 'budget', title: 'ÏòàÏÇ∞ Í≥ÑÌöç ÏàòÎ¶Ω', completed: false, priority: 'medium', category: 'planning' },
        { id: 'contacts', title: 'ÌòÑÏßÄ Ïó∞ÎùΩÏ≤ò ÌôïÎ≥¥', completed: false, priority: 'medium', category: 'planning' },
        { id: 'documents', title: 'ÌïÑÏöî ÏÑúÎ•ò Ï§ÄÎπÑ (Ïã†Î∂ÑÏ¶ù, Î™ÖÌï® Îì±)', completed: false, priority: 'low', category: 'planning' }
      ]
    },
    {
      id: 'approval',
      title: 'ÏäπÏù∏ Î∞è Í≤∞Ïû¨',
      description: 'Ï∂úÏû• ÏäπÏù∏ Î∞è Í¥ÄÎ†® Ï†àÏ∞®Î•º ÏôÑÎ£åÌï©ÎãàÎã§',
      icon: '‚úÖ',
      required: true,
      items: [
        { id: 'request', title: 'Ï∂úÏû• ÏäπÏù∏ ÏöîÏ≤≠ÏÑú ÏûëÏÑ±', completed: false, priority: 'high', category: 'approval' },
        { id: 'manager_approval', title: 'ÏÉÅÍ∏âÏûê ÏäπÏù∏ ÏôÑÎ£å', completed: false, priority: 'high', category: 'approval' },
        { id: 'travel_order', title: 'Ï∂úÏû•Î™ÖÎ†πÏÑú Î∞úÍ∏â', completed: false, priority: 'medium', category: 'approval' },
        { id: 'insurance', title: 'Ï∂úÏû• Î≥¥Ìóò Í∞ÄÏûÖ ÌôïÏù∏', completed: false, priority: 'low', category: 'approval' }
      ]
    },
    {
      id: 'booking',
      title: 'ÏòàÏïΩ Î∞è Ï§ÄÎπÑ',
      description: 'ÍµêÌÜµÌé∏, ÏàôÎ∞ï Îì±ÏùÑ ÏòàÏïΩÌï©ÎãàÎã§',
      icon: 'üé´',
      required: true,
      items: [
        { id: 'transport', title: 'ÍµêÌÜµÌé∏ ÏòàÏïΩ (Ìï≠Í≥µ, Í∏∞Ï∞®, Î≤ÑÏä§)', completed: false, priority: 'high', category: 'booking' },
        { id: 'accommodation', title: 'ÏàôÎ∞ïÏãúÏÑ§ ÏòàÏïΩ', completed: false, priority: 'high', category: 'booking' },
        { id: 'rental_car', title: 'Î†åÌÑ∞Ïπ¥ ÏòàÏïΩ (ÌïÑÏöîÏãú)', completed: false, priority: 'medium', category: 'booking' },
        { id: 'local_transport', title: 'ÌòÑÏßÄ ÍµêÌÜµÌé∏ ÌôïÏù∏', completed: false, priority: 'medium', category: 'booking' },
        { id: 'meeting_room', title: 'ÌöåÏùòÏã§ ÏòàÏïΩ (ÌïÑÏöîÏãú)', completed: false, priority: 'low', category: 'booking' }
      ]
    },
    {
      id: 'preparation',
      title: 'Ï∂úÏû• Ï§ÄÎπÑ',
      description: 'Ï∂úÏû•Ïóê ÌïÑÏöîÌïú Î¨ºÌíàÏùÑ Ï§ÄÎπÑÌï©ÎãàÎã§',
      icon: 'üéí',
      required: false,
      items: [
        { id: 'packing', title: 'Ï∂úÏû•Ïö©Ìíà Ìå®ÌÇπ', completed: false, priority: 'medium', category: 'preparation' },
        { id: 'laptop', title: 'ÎÖ∏Ìä∏Î∂Å Î∞è ÏóÖÎ¨¥ Ïû•ÎπÑ Ï§ÄÎπÑ', completed: false, priority: 'high', category: 'preparation' },
        { id: 'chargers', title: 'Ï∂©Ï†ÑÍ∏∞ Î∞è Ïñ¥ÎåëÌÑ∞ Ï§ÄÎπÑ', completed: false, priority: 'medium', category: 'preparation' },
        { id: 'business_cards', title: 'Î™ÖÌï® Ï§ÄÎπÑ', completed: false, priority: 'medium', category: 'preparation' },
        { id: 'emergency_kit', title: 'ÎπÑÏÉÅÏïΩÌíà Î∞è Íµ¨Í∏âÏö©Ìíà', completed: false, priority: 'low', category: 'preparation' }
      ]
    },
    {
      id: 'execution',
      title: 'Ï∂úÏû• Ïã§Ìñâ',
      description: 'Ï∂úÏû•ÏùÑ ÏßÑÌñâÌïòÍ≥† Í¥ÄÎ†® ÏóÖÎ¨¥Î•º ÏàòÌñâÌï©ÎãàÎã§',
      icon: '‚úàÔ∏è',
      required: true,
      items: [
        { id: 'departure', title: 'Ï∂úÎ∞ú Î∞è ÍµêÌÜµÌé∏ Ïù¥Ïö©', completed: false, priority: 'high', category: 'execution' },
        { id: 'checkin', title: 'ÏàôÎ∞ïÏãúÏÑ§ Ï≤¥ÌÅ¨Ïù∏', completed: false, priority: 'medium', category: 'execution' },
        { id: 'business_work', title: 'ÏóÖÎ¨¥ ÏàòÌñâ Î∞è ÎØ∏ÌåÖ Ï∞∏ÏÑù', completed: false, priority: 'high', category: 'execution' },
        { id: 'receipt_collection', title: 'ÏòÅÏàòÏ¶ù ÏàòÏßë Î∞è Ï†ïÎ¶¨', completed: false, priority: 'high', category: 'execution' },
        { id: 'return', title: 'Í∑ÄÌôò Î∞è Î≥µÍ∑Ä', completed: false, priority: 'high', category: 'execution' }
      ]
    },
    {
      id: 'settlement',
      title: 'Ï†ïÏÇ∞ Î∞è Î≥¥Í≥†',
      description: 'Ï∂úÏû• Í≤ΩÎπÑÎ•º Ï†ïÏÇ∞ÌïòÍ≥† Î≥¥Í≥†ÏÑúÎ•º ÏûëÏÑ±Ìï©ÎãàÎã§',
      icon: 'üí∞',
      required: true,
      items: [
        { id: 'expense_report', title: 'Í≤ΩÎπÑ Ï†ïÏÇ∞ÏÑú ÏûëÏÑ±', completed: false, priority: 'high', category: 'settlement' },
        { id: 'receipt_submit', title: 'ÏòÅÏàòÏ¶ù Ï†úÏ∂ú', completed: false, priority: 'high', category: 'settlement' },
        { id: 'trip_report', title: 'Ï∂úÏû• Î≥¥Í≥†ÏÑú ÏûëÏÑ±', completed: false, priority: 'medium', category: 'settlement' },
        { id: 'expense_approval', title: 'Í≤ΩÎπÑ ÏäπÏù∏ ÏôÑÎ£å', completed: false, priority: 'medium', category: 'settlement' },
        { id: 'final_settlement', title: 'ÏµúÏ¢Ö Ï†ïÏÇ∞ ÏôÑÎ£å', completed: false, priority: 'low', category: 'settlement' }
      ]
    }
  ]

  // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏÉÅÌÉú Î°úÎìú
  useEffect(() => {
    const savedChecklist = localStorage.getItem(`checklist_${tripId}`)
    if (savedChecklist) {
      try {
        const parsed = JSON.parse(savedChecklist)
        setChecklist(parsed)
        // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ï≤´ Î≤àÏß∏ Ïπ¥ÌÖåÍ≥†Î¶¨Îäî ÌôïÏû•
        setExpandedCategories(new Set(['planning']))
      } catch (error) {
        console.error('Failed to parse saved checklist:', error)
        initializeChecklist()
      }
    } else {
      initializeChecklist()
    }
  }, [tripId])

  const initializeChecklist = () => {
    setChecklist(checklistTemplate)
    setExpandedCategories(new Set(['planning']))
  }

  // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú Î≥ÄÍ≤Ω
  const handleItemToggle = (categoryId: string, itemId: string) => {
    setChecklist(prev => prev.map(category => {
      if (category.id === categoryId) {
        return {
          ...category,
          items: category.items.map(item => 
            item.id === itemId 
              ? { ...item, completed: !item.completed }
              : item
          )
        }
      }
      return category
    }))
    setHasChanges(true)
  }

  // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ÑÏ≤¥ ÌÜ†Í∏Ä
  const handleCategoryToggle = (categoryId: string) => {
    const category = checklist.find(cat => cat.id === categoryId)
    if (!category) return

    const allCompleted = category.items.every(item => item.completed)
    
    setChecklist(prev => prev.map(cat => {
      if (cat.id === categoryId) {
        return {
          ...cat,
          items: cat.items.map(item => ({ ...item, completed: !allCompleted }))
        }
      }
      return cat
    }))
    setHasChanges(true)
  }

  // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏû•/Ï∂ïÏÜå
  const toggleCategory = (categoryId: string) => {
    setExpandedCategories(prev => {
      const newSet = new Set(prev)
      if (newSet.has(categoryId)) {
        newSet.delete(categoryId)
      } else {
        newSet.add(categoryId)
      }
      return newSet
    })
  }

  // Ï†ÄÏû•
  const saveChecklist = () => {
    try {
      localStorage.setItem(`checklist_${tripId}`, JSON.stringify(checklist))
      setHasChanges(false)
      toast({
        title: "Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ Ï†ÄÏû• ÏôÑÎ£å",
        description: "Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.",
      })
    } catch (error) {
      toast({
        title: "Ï†ÄÏû• Ïã§Ìå®",
        description: "Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
        variant: "destructive",
      })
    }
  }

  // Ï†ÑÏ≤¥ ÏßÑÌñâÎ•† Í≥ÑÏÇ∞
  const totalItems = checklist.reduce((sum, category) => sum + category.items.length, 0)
  const completedItems = checklist.reduce((sum, category) => 
    sum + category.items.filter(item => item.completed).length, 0
  )
  const progressPercentage = totalItems > 0 ? (completedItems / totalItems) * 100 : 0

  // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏßÑÌñâÎ•† Í≥ÑÏÇ∞
  const getCategoryProgress = (category: ChecklistCategory) => {
    const completed = category.items.filter(item => item.completed).length
    return category.items.length > 0 ? (completed / category.items.length) * 100 : 0
  }

  // Ïö∞ÏÑ†ÏàúÏúÑÎ≥Ñ ÏÉâÏÉÅ
  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high': return 'text-red-600'
      case 'medium': return 'text-yellow-600'
      case 'low': return 'text-green-600'
      default: return 'text-gray-600'
    }
  }

  // Ïö∞ÏÑ†ÏàúÏúÑÎ≥Ñ ÎùºÎ≤®
  const getPriorityLabel = (priority: string) => {
    switch (priority) {
      case 'high': return 'ÎÜíÏùå'
      case 'medium': return 'Î≥¥ÌÜµ'
      case 'low': return 'ÎÇÆÏùå'
      default: return ''
    }
  }

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <CardTitle className="flex items-center gap-2">
            <CheckCircle2 className="w-5 h-5" />
            Ï∂úÏû• Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
          </CardTitle>
          {hasChanges && (
            <Button onClick={saveChecklist} size="sm" variant="outline">
              <Save className="w-4 h-4 mr-2" />
              Ï†ÄÏû•
            </Button>
          )}
        </div>
        <div className="space-y-2">
          <div className="flex items-center justify-between text-sm">
            <span className="text-muted-foreground">
              Ï†ÑÏ≤¥ ÏßÑÌñâÎ•†: {completedItems}/{totalItems} ÏôÑÎ£å
            </span>
            <span className="font-medium">{Math.round(progressPercentage)}%</span>
          </div>
          <Progress value={progressPercentage} className="h-2" />
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        {checklist.map((category) => {
          const isExpanded = expandedCategories.has(category.id)
          const categoryProgress = getCategoryProgress(category)
          const completedCount = category.items.filter(item => item.completed).length
          
          return (
            <Collapsible
              key={category.id}
              open={isExpanded}
              onOpenChange={() => toggleCategory(category.id)}
            >
              <CollapsibleTrigger asChild>
                <div className="flex items-center justify-between p-3 bg-muted/50 rounded-lg cursor-pointer hover:bg-muted/70 transition-colors">
                  <div className="flex items-center gap-3">
                    <div className="flex items-center gap-2">
                      {isExpanded ? (
                        <ChevronDown className="w-4 h-4" />
                      ) : (
                        <ChevronRight className="w-4 h-4" />
                      )}
                      <span className="text-lg">{category.icon}</span>
                    </div>
                    <div>
                      <h3 className="font-semibold flex items-center gap-2">
                        {category.title}
                        {category.required && (
                          <Badge variant="secondary" className="text-xs">ÌïÑÏàò</Badge>
                        )}
                      </h3>
                      <p className="text-sm text-muted-foreground">{category.description}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <div className="text-right">
                      <div className="text-sm font-medium">
                        {completedCount}/{category.items.length}
                      </div>
                      <div className="text-xs text-muted-foreground">
                        {Math.round(categoryProgress)}%
                      </div>
                    </div>
                    <div className="w-16">
                      <Progress value={categoryProgress} className="h-2" />
                    </div>
                  </div>
                </div>
              </CollapsibleTrigger>
              <CollapsibleContent>
                <div className="mt-3 ml-6 space-y-2">
                  <div className="flex items-center gap-2 mb-3">
                    <Checkbox
                      id={`category-${category.id}`}
                      checked={category.items.every(item => item.completed)}
                      onCheckedChange={() => handleCategoryToggle(category.id)}
                    />
                    <label 
                      htmlFor={`category-${category.id}`}
                      className="text-sm font-medium cursor-pointer"
                    >
                      Ï†ÑÏ≤¥ ÏÑ†ÌÉù/Ìï¥Ï†ú
                    </label>
                  </div>
                  {category.items.map((item) => (
                    <div 
                      key={item.id}
                      className="flex items-center gap-3 p-2 rounded hover:bg-muted/30 transition-colors"
                    >
                      <Checkbox
                        id={`item-${item.id}`}
                        checked={item.completed}
                        onCheckedChange={() => handleItemToggle(category.id, item.id)}
                      />
                      <label 
                        htmlFor={`item-${item.id}`}
                        className={`flex-1 text-sm cursor-pointer ${
                          item.completed ? 'line-through text-muted-foreground' : ''
                        }`}
                      >
                        {item.title}
                      </label>
                      <Badge 
                        variant="outline" 
                        className={`text-xs ${getPriorityColor(item.priority)}`}
                      >
                        {getPriorityLabel(item.priority)}
                      </Badge>
                      {item.completed && (
                        <CheckCircle2 className="w-4 h-4 text-green-600" />
                      )}
                    </div>
                  ))}
                </div>
              </CollapsibleContent>
            </Collapsible>
          )
        })}

        {/* ÏßÑÌñâ ÏÉÅÌÉú ÏöîÏïΩ */}
        <div className="mt-6 p-4 bg-muted/30 rounded-lg">
          <h4 className="font-semibold mb-2 flex items-center gap-2">
            <Clock className="w-4 h-4" />
            ÏßÑÌñâ ÏÉÅÌÉú ÏöîÏïΩ
          </h4>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-green-500 rounded-full"></div>
              <span>ÏôÑÎ£å: {completedItems}Í∞ú</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-gray-300 rounded-full"></div>
              <span>ÎØ∏ÏôÑÎ£å: {totalItems - completedItems}Í∞ú</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
              <span>Ï†ÑÏ≤¥: {totalItems}Í∞ú</span>
            </div>
          </div>
          {progressPercentage === 100 && (
            <div className="mt-3 p-2 bg-green-100 text-green-800 rounded text-sm flex items-center gap-2">
              <CheckCircle2 className="w-4 h-4" />
              Î™®Îì† Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! üéâ
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  )
}